#!/bin/sh
. "$(dirname "$0")/husky.sh"

# ì•ˆì „ëª¨ë“œ + ë¡œê·¸
set -euo pipefail

echo "ğŸ”§ [pre-commit] 1) lint-staged ì‹¤í–‰"
npx lint-staged

echo "ğŸ” [pre-commit] 2) TypeScript íƒ€ì…ì²´í¬(frontend)"
npm --prefix frontend run typecheck

echo "ğŸ§ª [pre-commit] 3) Jest í…ŒìŠ¤íŠ¸(frontend)"
# ê¸°ë³¸ì€ package.jsonì˜ ì„¤ì •ì„ ì‚¬ìš©.
npm --prefix frontend run test

echo "ğŸ›  [pre-commit] 4) Java ì •ì ë¶„ì„ (Maven in Docker: Checkstyle/PMD/SpotBugs)"
# docker/compose ì ê²€
if ! command -v docker >/dev/null 2>&1; then
  echo "âŒ Dockerê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
  exit 1
fi
if ! docker compose version >/dev/null 2>&1; then
  echo "âŒ Docker Composeê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
  exit 1
fi

# ë°±ì—”ë“œ(POM) ì¡´ì¬ ì‹œì—ë§Œ ê²€ì‚¬ ìˆ˜í–‰
if [ -f "pom.xml" ]; then
  # ì»¨í…Œì´ë„ˆì—ì„œ Maven ì‹¤í–‰(ì˜ì¡´ì„± ìºì‹œëŠ” composeì˜ maven-repo ë³¼ë¥¨ ì‚¬ìš©)
  # ì†ë„ ìœ„í•´ í…ŒìŠ¤íŠ¸ëŠ” ìƒëµ(-DskipTests), ì •ì ë¶„ì„ ìœ„ë°˜ ì‹œ ì‹¤íŒ¨í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆì–´ commit ì°¨ë‹¨ë¨
  docker compose run --rm code-quality \
    "mvn -q -DskipTests clean verify" || {
      echo 'âŒ Java ì •ì ë¶„ì„ ì‹¤íŒ¨(Checkstyle/PMD/SpotBugs) â†’ ì»¤ë°‹ ì°¨ë‹¨'
      exit 1
    }
else
  echo "â„¹ï¸ pom.xmlì´ ì—†ì–´ Java ì •ì ë¶„ì„ì€ ê±´ë„ˆëœë‹ˆë‹¤."
fi

echo "âœ… [pre-commit] ì™„ë£Œ"
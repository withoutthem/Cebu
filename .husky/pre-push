#!/bin/sh
# =====================================================================
# Husky pre-push hook
# - FE: ê°œë°œ ë¹Œë“œ (build:dev > build ìš°ì„ ìˆœìœ„)
# - BE: ê°œë°œ ë¹Œë“œ (Maven package, dev í”„ë¡œí•„ ê°ì§€ ì‹œ -P dev)
# - ëª¨ë“  ë¹Œë“œ ì„±ê³µ ì‹œì—ë§Œ push ì§„í–‰
# =====================================================================

. "$(dirname "$0")/husky.sh"
set -euo pipefail

# --------------------------- Helpers ---------------------------------
CYN='\033[36m'; GRN='\033[32m'; YLW='\033[33m'; RED='\033[31m'; MAG='\033[35m'; NC='\033[0m'
log()   { printf "${CYN}%s${NC}\n" "$*"; }
ok()    { printf "âœ… ${GRN}%s${NC}\n" "$*"; }
warn()  { printf "âš ï¸  ${YLW}%s${NC}\n" "$*"; }
fail()  { printf "âŒ ${RED}%s${NC}\n" "$*" >&2; exit 1; }
divider(){ printf "\n${MAG}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n\n"; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

divider
log "ğŸš€ pre-push ì‹œì‘: FE/BE ê°œë°œ ë¹Œë“œ ê²€ì¦"

# ------------------------ Step 0: í™˜ê²½ ì ê²€ ---------------------------
command -v node >/dev/null 2>&1 || warn "node ë¯¸ì„¤ì¹˜: FE ë¹Œë“œ ìŠ¤í‚µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
command -v npm  >/dev/null 2>&1 || warn "npm  ë¯¸ì„¤ì¹˜: FE ë¹Œë“œ ìŠ¤í‚µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
[ -f "./mvnw" ] || warn "./mvnw ì—†ìŒ: BE ë¹Œë“œëŠ” ì‹œìŠ¤í…œ mvn ì‚¬ìš© ì‹œë„"

# ------------------------ Step 1: FE Build ----------------------------
divider
log "ğŸ§± [Step 1] Frontend ê°œë°œ ë¹Œë“œ"

if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
  # ì˜ì¡´ì„± ì„¤ì¹˜(ì´ë¯¸ ì„¤ì¹˜ë¼ ìˆìœ¼ë©´ ë¹ ë¥´ê²Œ í†µê³¼)
  if command -v npm >/dev/null 2>&1; then
    log "ğŸ“¦ npm ci (ì—†ìœ¼ë©´ npm i)â€¦"
    if [ -f "frontend/package-lock.json" ]; then
      npm --prefix frontend ci >/dev/null 2>&1 || npm --prefix frontend install
    else
      npm --prefix frontend install
    fi
  else
    warn "npm ë¯¸ì„¤ì¹˜ â†’ FE ë¹Œë“œ ìŠ¤í‚µ"
  fi

  # ì‚¬ìš©í•  ìŠ¤í¬ë¦½íŠ¸ ê²°ì •: build:dev > vite build --mode development > build
  FE_CMD=""
  if command -v node >/dev/null 2>&1 && node -e "process.exit(!require('./frontend/package.json').scripts?.['build:dev'])"; then
    FE_CMD="npm --prefix frontend run build:dev"
  elif command -v npx >/dev/null 2>&1; then
    # vite í”„ë¡œì íŠ¸ì¼ ê²½ìš° ëŒ€ë¹„(ì—†ìœ¼ë©´ ë‹¤ìŒ ë¶„ê¸°ë¡œ)
    npx --yes --prefix frontend --package vite -- vite -v >/dev/null 2>&1 && FE_CMD="npx --prefix frontend vite build --mode development" || true
  fi
  [ -z "${FE_CMD}" ] && FE_CMD="npm --prefix frontend run build"

  log "ğŸ— ì‹¤í–‰: ${FE_CMD}"
  sh -c "${FE_CMD}" || fail "Frontend ê°œë°œ ë¹Œë“œ ì‹¤íŒ¨ â†’ push ì¤‘ë‹¨"

  ok "Frontend ê°œë°œ ë¹Œë“œ í†µê³¼"
else
  warn "frontend í´ë” ë˜ëŠ” package.json ì—†ìŒ â†’ FE ë¹Œë“œ ìŠ¤í‚µ"
fi

# ------------------------ Step 2: BE Build ----------------------------
divider
log "ğŸ— [Step 2] Backend ê°œë°œ ë¹Œë“œ"

if [ -d "backend" ] && [ -f "backend/pom.xml" ]; then
  MVN="./mvnw"
  command -v "$MVN" >/dev/null 2>&1 || MVN="mvn"

  # dev í”„ë¡œí•„ ì¡´ì¬ ì‹œ ìë™ ì‚¬ìš©
  if grep -q "<id>dev</id>" backend/pom.xml 2>/dev/null; then
    BE_PROFILE="-P dev"
  else
    BE_PROFILE=""
  fi

  # í…ŒìŠ¤íŠ¸ëŠ” ê°œë°œ ë¹Œë“œì—ì„œ ë³´í†µ ê±´ë„ˆëœ€(ì›í•˜ì‹œë©´ ì œê±°)
  BE_CMD="$MVN -q -f backend/pom.xml clean package -DskipTests ${BE_PROFILE}"
  log "ğŸ— ì‹¤í–‰: ${BE_CMD}"
  sh -c "${BE_CMD}" || fail "Backend ê°œë°œ ë¹Œë“œ ì‹¤íŒ¨ â†’ push ì¤‘ë‹¨"

  ok "Backend ê°œë°œ ë¹Œë“œ í†µê³¼"
else
  warn "backend í´ë” ë˜ëŠ” pom.xml ì—†ìŒ â†’ BE ë¹Œë“œ ìŠ¤í‚µ"
fi

divider
ok "ğŸ‰ ëª¨ë“  ë¹Œë“œ í†µê³¼ â†’ push ì§„í–‰"